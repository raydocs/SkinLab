# fn-12-z04: 无障碍与分析 - Accessibility & Analytics

## Problem Statement
1. **无障碍缺失**: 代码库中 accessibilityLabel 使用稀疏，VoiceOver 用户体验差
2. **分析服务未集成**: AnalyticsEvents.swift 只有 TODO 注释，无法追踪用户行为
3. **行为数据缺失**: 无法了解用户使用模式，难以优化产品

**用户痛点**: 视障用户无法使用app；产品团队无数据驱动决策

## Scope
- 全面添加无障碍标签
- 集成分析服务（Firebase Analytics 或 Mixpanel）
- 关键用户行为追踪
- 转化漏斗分析

## Approach

### Task 1: 无障碍标签
```swift
// 现状: 稀疏的 accessibilityLabel
// 目标: 所有交互元素都有标签

// 示例
Button(action: takePhoto) {
    Image(systemName: "camera")
}
.accessibilityLabel("拍摄皮肤照片")
.accessibilityHint("打开相机进行皮肤分析")
```

### Task 2: 分析服务集成
```swift
// AnalyticsEvents.swift 现状
static func logEvent(name: String, parameters: [String: Any]? = nil) {
    // TODO: Integrate with analytics provider
    #if DEBUG
    print("[Analytics] \(name): \(parameters ?? [:])")
    #endif
}

// 目标: 实际集成
// 选项 A: Firebase Analytics (免费，Google生态)
// 选项 B: Mixpanel (更强大的漏斗分析)
```

### Task 3: 关键事件定义
- 用户注册/登录
- 首次分析完成
- 打卡完成
- 产品添加
- 报告查看
- 功能使用（预测、场景、天气等）

### Task 4: 漏斗分析
- 新用户激活漏斗
- 日活/周活追踪
- 功能留存分析

## Quick commands
```bash
xcodebuild build -scheme SkinLab -destination 'platform=iOS Simulator,name=iPhone 17'
xcodebuild test -scheme SkinLab -destination 'platform=iOS Simulator,name=iPhone 17'
```

## Acceptance
- [ ] 所有按钮有 accessibilityLabel
- [ ] 所有图片有 accessibilityLabel
- [ ] 复杂组件有 accessibilityHint
- [ ] VoiceOver 可完成核心流程
- [ ] 分析服务集成完成
- [ ] 关键事件正确上报
- [ ] DEBUG模式可查看事件日志

## Key Files
- `/SkinLab/Services/AnalyticsEvents.swift` - 分析服务入口
- `/SkinLab/Features/Analysis/Views/AnalysisView.swift` - 分析流程
- `/SkinLab/Features/Tracking/Views/TrackingView.swift` - 打卡流程
- `/SkinLab/Features/Analysis/Views/HomeView.swift` - 首页
- 所有 Views 目录下的视图文件

## Technical Details

### 无障碍审计清单
```swift
// 1. 按钮
.accessibilityLabel("操作描述")
.accessibilityHint("操作结果说明")

// 2. 图片
.accessibilityLabel("图片内容描述")
// 装饰性图片
.accessibilityHidden(true)

// 3. 图表
.accessibilityElement(children: .combine)
.accessibilityLabel("皮肤评分趋势图")
.accessibilityValue("最近7天平均分75分，上升趋势")

// 4. 自定义控件
.accessibilityAddTraits(.isButton)
.accessibilityRemoveTraits(.isImage)
```

### Firebase Analytics 集成
```swift
// 1. 添加 SPM 依赖
// https://github.com/firebase/firebase-ios-sdk

// 2. 初始化
import FirebaseAnalytics

// AppDelegate 或 App init
FirebaseApp.configure()

// 3. 记录事件
Analytics.logEvent("skin_analysis_completed", parameters: [
    "skin_type": skinType.rawValue,
    "score": score
])
```

### 事件命名规范
```swift
enum AnalyticsEvent: String {
    // 用户生命周期
    case userSignUp = "user_sign_up"
    case userLogin = "user_login"
    case profileCompleted = "profile_completed"

    // 核心功能
    case analysisStarted = "analysis_started"
    case analysisCompleted = "analysis_completed"
    case checkInCompleted = "check_in_completed"

    // 功能使用
    case productAdded = "product_added"
    case reportViewed = "report_viewed"
    case scenarioSelected = "scenario_selected"
    case weatherViewed = "weather_viewed"
}
```

## Risks & Mitigations
| 风险 | 缓解措施 |
|------|----------|
| 隐私合规 | 遵循 ATT 框架，仅收集必要数据 |
| 性能影响 | 异步上报，批量发送 |
| 标签维护成本 | 建立代码审查检查项 |

## Dependencies
- Firebase Analytics SDK 或 Mixpanel SDK
- App Tracking Transparency framework
- 无障碍测试工具 (Accessibility Inspector)

## References
- Apple Accessibility Programming Guide
- Firebase Analytics iOS Setup
- `AnalyticsEvents.swift` - 现有桩实现
